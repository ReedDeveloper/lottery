## 闽南中秋博饼规则

博饼 (Bó Bǐng)，又称“状元筹”或“会饼”，是流行于中国闽南地区（特别是厦门、漳州等地）在中秋节期间特有的民俗活动。它是一种独特的掷骰子游戏，旨在通过掷骰子组合来赢得不同等级的奖品，寄寓着吉祥和好运。

**核心规则：**

1.  **道具：** 通常使用六颗骰子和一个大瓷碗。
2.  **奖品：** 游戏开始前会准备好各种奖品，传统上是月饼，现在则可以是日常用品、现金、电器等。这些奖品根据博饼的奖项等级进行划分。
3.  **参与方式：** 玩家轮流掷骰子。
4.  **奖项判定：** 每次掷出六颗骰子后，根据骰子的组合来判定玩家获得的奖项。其中，骰子点数中的“四点红”（即红色的四点）是判定高等级奖项的关键。

**奖项等级（由低到高）：**

  * **一秀 (Yī Xiù)：** 六颗骰子中，任意一颗骰子为“四点红”。
  * **二举 (Èr Jǔ)：** 六颗骰子中，任意两颗骰子为“四点红”。
  * **三红 (Sān Hóng)：** 六颗骰子中，任意三颗骰子为“四点红”。
  * **四进 (Sì Jìn)：** 六颗骰子中，有四颗骰子点数相同（但不是四个“四点红”）。例如：四个一、四个二、四个三、四个五、四个六。
  * **对堂 (Duì Táng)：** 六颗骰子点数分别为一、二、三、四、五、六（即顺子）。
  * **状元 (Zhuàngyuán)：** 这是最高等级的奖项，根据“四点红”的数量和特定组合有多个子类别：
      * **四点红状元：** 四颗骰子为“四点红”，另外两颗任意。这是最常见的状元。
      * **五子登科：** 五颗骰子点数相同。例如：五个一、五个二等。
      * **六杯红：** 六颗骰子全部为“四点红”。这是最稀有、最受追捧的状元。
      * **六杯黑：** 六颗骰子点数全部相同，但不是“四点红”。例如：六个一、六个二等。
      * **状元插金花：** 四颗骰子为“四点红”，另外两颗为“一点”。这被认为是特别吉祥的组合。

**胜负判定：**

  * 玩家根据掷出的奖项领取相应的奖品。
  * 游戏通常会持续到所有预设的“状元”奖品都被领取完毕。
  * 在某些玩法中，最终掷出最高等级“状元”（如六杯红）的玩家会被尊为本场游戏的“状元”，并可能获得一份特别大奖。
  * 如果多名玩家掷出相同等级的“状元”，可能会进行“比大小”的加赛，再次掷骰子来决定最终的获奖者。

**特殊规则和注意事项：**

  * **优先级：** 高等级奖项优先于低等级奖项。例如，如果掷出“对堂”，则不再计算“一秀”等。
  * **奖品分配：** 具体的奖品种类和数量在游戏开始前由组织者确定。
  * **游戏氛围：** 博饼更注重参与的乐趣、节日的喜庆和吉祥寓意，而非纯粹的竞技输赢。

## 博饼游戏程序开发文档说明

### 1\. 引言

本文档旨在为开发一款支持网页端远程联机博饼游戏提供全面的指导。该游戏将模拟闽南中秋博饼的规则，允许玩家通过互联网参与，体验这一独特的传统习俗。

### 2\. 目标

  * 实现博饼游戏的核心规则，包括骰子投掷、奖项判定及奖品分配。
  * 提供直观的用户界面，支持多名玩家远程联机游戏。
  * 确保游戏的公平性、随机性和稳定性。
  * 支持多种博饼奖项配置，允许自定义奖品。
  * 提供实时游戏状态更新。

### 3\. 系统架构

该系统将采用典型的客户端-服务端（Client-Server）架构。

  * **客户端 (Client-Side):** 负责用户界面展示、用户输入（投掷骰子请求）、游戏状态渲染。
  * **服务端 (Server-Side):** 负责游戏逻辑处理、随机数生成（骰子点数）、房间管理、玩家连接管理、奖项判定、游戏状态同步。

<!-- end list -->

```
+------------------+     +------------------+
|    Client (Web)  |     |    Client (Web)  |
|                  |     |                  |
| - User Interface |     | - User Interface |
| - Send Actions   |     | - Send Actions   |
| - Render State   |     | - Render State   |
+--------^---------+     +--------^---------+
         |                        |
         | (WebSocket/HTTP)       | (WebSocket/HTTP)
         v                        v
+-----------------------------------+
|          Server                   |
|                                   |
| - Game Room Management            |
| - Player Connection Management    |
| - Dice Roll Logic (Random Number) |
| - Prize Determination Engine      |
| - Game State Synchronization      |
| - Database (Optional: for history)|
+-----------------------------------+
```

### 4\. 技术选型

#### 4.1. 服务端 (Server-Side)

  * **编程语言:**
      * **Python (with frameworks like Flask/Django)
  * **Web框架:**
      * **Node.js:** Express.js, NestJS
  * **实时通信:**
      * **WebSocket:** 实现客户端与服务端之间的双向实时通信，适合游戏状态同步和即时响应。推荐使用 `Socket.IO` (Node.js) 库 。
  * **数据库 (可选):**
      * **NoSQL (MongoDB, Redis):** 适合存储游戏状态、玩家信息、历史记录等，读写性能高。
  * **部署:** Docker

#### 4.2. 客户端 (Client-Side)

  * **前端框架/库:**
      * **React, Vue.js, Angular:** 提供组件化开发、响应式数据绑定，便于构建复杂的用户界面。
  * **HTML5/CSS3:** 页面结构和样式。
  * **JavaScript (ES6+):** 核心交互逻辑。
  * **实时通信:**
      * **WebSocket API:** 浏览器原生支持。
      * **Socket.IO Client Library:** 与服务端 `Socket.IO` 配合使用。
  * **图形渲染:**
      * **CSS Animations/Transitions:** 模拟骰子滚动效果。
      * **Canvas/WebGL (Three.js):** 如果需要更逼真的3D骰子效果。

### 5\. 功能模块

#### 5.1. 用户认证与房间管理 (User Authentication & Room Management)

  * **注册/登录:** (可选) 允许玩家创建账户并登录。
  * **创建房间:** 玩家可以创建新的游戏房间，并设置房间名称、密码（可选）、玩家数量限制。
  * **加入房间:** 玩家可以通过房间ID或列表加入现有房间。
  * **房间列表:** 显示当前可用的游戏房间。
  * **离开房间:** 玩家可以随时离开房间。

#### 5.2. 游戏核心逻辑 (Game Core Logic)

  * **骰子投掷:**
      * 客户端发送投掷请求到服务端。
      * 服务端生成6个随机数（1-6），模拟骰子点数。
      * 服务端将骰子结果广播给房间内所有玩家。
  * **奖项判定:**
      * 服务端根据骰子结果，按照博饼规则判定所获得的奖项（一秀、二举、三红、四进、对堂、状元及子分类）。
      * 优先级：状元 \> 对堂 \> 四进 \> 三红 \> 二举 \> 一秀。
      * 处理多个奖项同时出现的情况（例如：对堂中包含一个四点红，优先判对堂）。
  * **奖品分配:**
      * 根据判定的奖项，从预设的奖品池中分配对应的奖品给当前投掷的玩家。
      * 记录已分配的奖品数量。
  * **游戏状态管理:**
      * 维护每个房间的游戏状态：当前玩家、已投掷轮次、已获得的奖品、剩余奖品等。
      * 实时同步游戏状态到所有客户端。
  * **游戏结束判断:**
      * 当所有状元奖品被领完时，游戏结束。
      * 统计并显示最终的状元得主。

#### 5.3. 玩家交互与界面 (Player Interaction & UI)

  * **游戏主界面:**
      * 显示骰子区域：投掷前显示空白，投掷后显示骰子点数。
      * “投掷”按钮。
      * 当前玩家信息：昵称、头像。
      * 当前轮次提示。
      * 玩家列表：显示房间内所有玩家，当前轮到谁。
      * 奖品展示区：显示所有奖品类型和剩余数量。
      * 个人奖品列表：显示当前玩家已获得的奖品。
      * 聊天窗口 (可选): 允许玩家之间进行文字交流。
  * **投掷动画:** 模拟骰子在碗中滚动的效果。
  * **获奖提示:** 投掷后，如果获得奖项，弹出醒目的提示信息。

#### 5.4. 后台管理 (Admin Panel - Optional)

  * **奖品配置:** 允许管理员添加、修改、删除奖品类型、数量和图片。
  * **房间管理:** 强制关闭房间、查看活跃房间等。
  * **日志查看:** 游戏日志、错误日志。

### 6\. 数据结构

#### 6.1. 骰子结果 (Dice Roll Result)

```json
{
    "dice_values": [3, 4, 1, 6, 4, 2], // 六个骰子点数
    "prize_type": "一秀", // 获得的奖项类型
    "prize_details": {
        "name": "中秋月饼",
        "quantity": 1
    }
}
```

#### 6.2. 玩家信息 (Player Information)

```json
{
    "player_id": "uuid-1234",
    "nickname": "张三",
    "avatar_url": "http://example.com/avatar.png",
    "is_current_turn": true,
    "has_rolled_this_turn": false,
    "obtained_prizes": [
        {"name": "中秋月饼", "quantity": 2},
        {"name": "洗发水", "quantity": 1}
    ]
}
```

#### 6.3. 奖品配置 (Prize Configuration)

```json
[
    {
        "prize_id": "p001",
        "name": "一秀月饼",
        "type": "一秀",
        "total_quantity": 20,
        "remaining_quantity": 20,
        "image_url": "http://example.com/prizes/yixiu.png"
    },
    {
        "prize_id": "p002",
        "name": "状元大礼包",
        "type": "状元",
        "subtype": "四点红", // 状元下的子类型，方便判定
        "total_quantity": 3,
        "remaining_quantity": 3,
        "image_url": "http://example.com/prizes/zhuangyuan.png"
    }
    // ... 其他奖品
]
```

#### 6.4. 房间状态 (Room State)

```json
{
    "room_id": "room-xyz",
    "room_name": "中秋博饼乐",
    "players": [
        {"player_id": "uuid-1234", "nickname": "张三"},
        {"player_id": "uuid-5678", "nickname": "李四"}
    ],
    "current_turn_player_id": "uuid-1234",
    "round_number": 5,
    "prizes_config": [ /* 完整的奖品配置列表，包含剩余数量 */ ],
    "game_over": false,
    "winner_player_id": null // 游戏结束时的总状元
}
```

### 7\. API设计

使用 WebSocket 进行实时通信。以下是事件示例：

#### 7.1. 客户端 -\> 服务端 (Client -\> Server)

  * `join_room`: 加入房间。
      * `data`: `{ room_id: "...", nickname: "..." }`
  * `create_room`: 创建房间。
      * `data`: `{ room_name: "...", password: "...", max_players: 8 }`
  * `leave_room`: 离开房间。
  * `roll_dice`: 投掷骰子。
  * `chat_message`: 发送聊天消息 (可选)。
      * `data`: `{ message: "..." }`

#### 7.2. 服务端 -\> 客户端 (Server -\> Client)

  * `room_joined`: 成功加入房间。
      * `data`: `{ room_id: "...", room_name: "...", players: [...], current_state: {...} }`
  * `room_error`: 加入/创建房间失败。
      * `data`: `{ code: "...", message: "..." }`
  * `player_joined`: 新玩家加入房间。
      * `data`: `{ player_id: "...", nickname: "..." }`
  * `player_left`: 玩家离开房间。
      * `data`: `{ player_id: "..." }`
  * `dice_rolled`: 骰子投掷结果。
      * `data`: `{ player_id: "...", dice_values: [...], prize_type: "...", prize_details: {...}, current_player_prizes: [...], remaining_prizes: {...} }`
  * `next_turn`: 轮到下一位玩家。
      * `data`: `{ next_player_id: "..." }`
  * `game_over`: 游戏结束。
      * `data`: `{ winner_player_id: "...", final_results: {...} }`
  * `game_state_update`: 全局游戏状态更新 (可用于同步所有信息)。
      * `data`: `{ room_state: {...} }`
  * `chat_message`: 接收聊天消息 (可选)。
      * `data`: `{ player_id: "...", nickname: "...", message: "..." }`

### 8\. 开发计划

#### 阶段1: 核心功能开发 (Phase 1: Core Functionality)

  * 搭建服务端基础框架。
  * 实现玩家连接、房间创建与加入。
  * 实现骰子投掷逻辑和随机数生成。
  * 实现奖项判定核心算法。
  * 实现基本的游戏状态同步（下一轮、骰子结果）。
  * 客户端基础UI和骰子显示。

#### 阶段2: 奖品管理与完善 (Phase 2: Prize Management & Refinement)

  * 服务端奖品配置管理。
  * 客户端奖品显示和玩家已获奖品列表。
  * 实现所有状元子类型的判定。
  * 优化骰子投掷动画。
  * 增加错误处理和日志记录。

#### 阶段3: 用户体验与扩展 (Phase 3: User Experience & Extension)

  * 添加聊天功能 (可选)。
  * 美化UI/UX，提升视觉效果。
  * 增加音效和背景音乐。
  * 实现更高级的房间管理功能（密码房间、最大玩家数限制）。
  * (可选) 实现用户认证和历史记录。

#### 阶段4: 测试与部署 (Phase 4: Testing & Deployment)

  * 进行单元测试、集成测试、压力测试。
  * 修复Bug。
  * 部署到生产环境。
  * 持续监控和维护。

### 9\. 安全考虑

  * **随机数生成:** 使用安全的伪随机数生成器 (CSPRNG)，确保骰子点数的随机性和不可预测性。
  * **输入验证:** 验证所有来自客户端的输入，防止恶意数据或注入攻击。
  * **身份验证与授权:** 如果有用户系统，确保身份验证和授权的安全性。
  * **DDoS防护:** 考虑使用CDN或Nginx等进行DDoS防护。
  * **WebSocket安全:** 使用 `wss://` (WebSocket Secure) 协议，确保通信加密。
  * **游戏公平性:** 服务端负责骰子结果和奖项判定，避免客户端篡改。

### 10\. 性能考虑

  * **并发处理:** 服务端选择高并发框架 (Node.js/Go) 处理大量同时在线玩家。
  * **WebSocket优化:** 保持连接活跃，减少不必要的重连。
  * **数据传输量:** 优化游戏状态同步的数据结构，只传输必要的数据。
  * **数据库优化:** 如果使用数据库，进行索引优化、连接池管理。
  * **前端性能:** 优化前端渲染，减少DOM操作，使用虚拟DOM (React/Vue) 等。

### 11\. 附录

  * **博饼详细规则表格:** (可以根据实际的厦门或漳州规则进行细化，尤其是状元类别)
  * **奖品列表示例:**
      * 一秀：小份月饼、纸巾、洗发水
      * 二举：中份月饼、香皂、牙膏
      * 三红：大份月饼、食用油、米
      * 四进：电饭煲、榨汁机
      * 对堂：自行车、小家电
      * 状元 (四点红)：高档音响、现金红包
      * 状元 (五子登科)：电视机
      * 状元 (六杯红)：冰箱、洗衣机

这份文档提供了一个全面的框架，用于开发一个功能完善的博饼游戏。在实际开发中，可以根据具体需求和资源进行调整和细化。